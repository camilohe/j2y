---

phases:
  - phase: Windows
    queue: Hosted VS2017
    steps:
      -
        powershell: |
          Write-Host "##vso[build.updatebuildnumber]v0.0.2.$env:BUILD_BUILDID"
      -
        task: PowerShell@1
        displayName: Check Format
        inputs:
          scriptType: filePath
          scriptName: ./ci/windows/build.ps1
          arguments: "-Format"
          workingFolder: ""
          failOnStandardError: "false"
      -
        task: PowerShell@1
        displayName: Run Tests
        inputs:
          scriptType: filePath
          scriptName: ./ci/windows/build.ps1
          arguments: "-Test"
          workingFolder: ""
          failOnStandardError: "false"
      -
        task: PowerShell@1
        displayName: Build
        inputs:
          scriptType: filePath
          scriptName: ./ci/windows/build.ps1
          arguments: "-Build -Release"
          workingFolder: ""
          failOnStandardError: "false"
      -
        task: PublishBuildArtifacts@1
        displayName: "Publish Artifact: Release Build"
        inputs:
          PathtoPublish: ./target/release/j2y.exe
          ArtifactName: drop
          ArtifactType: Container
          TargetPath: "\\\\my\\share\\$(Build.DefinitionName)\\$(Build.BuildNumber)"
          Parallel: "false"
          ParallelCount: "8"
  - phase: Linux
    dependsOn: Windows
    queue: Hosted Linux Preview
    steps:
      -
        task: ShellScript@2
        displayName: Install Rust
        inputs:
          scriptPath: ./ci/linux/install.sh
      -
        task: ShellScript@2
        displayName: Check Syntax
        inputs:
          scriptPath: ./ci/linux/format.sh
      -
        task: ShellScript@2
        displayName: Run Tests
        inputs:
          scriptPath: ./ci/linux/test.sh
      -
        task: ShellScript@2
        displayName: Build
        inputs:
          scriptPath: ./ci/linux/build.sh
      -
        task: ShellScript@2
        displayName: Rename Executable
        inputs:
          scriptPath: ./ci/linux/move.sh
      -
        task: PublishBuildArtifacts@1
        displayName: "Publish Artifact: Release Build"
        inputs:
          PathtoPublish: ./target/release/j2y-linux
          ArtifactName: drop
          ArtifactType: Container
          TargetPath: "\\\\my\\share\\$(Build.DefinitionName)\\$(Build.BuildNumber)"
          Parallel: "false"
          ParallelCount: "8"
  - phase: Mac
    dependsOn: Linux
    queue: Hosted MacOS Preview
    steps:
      -
        task: ShellScript@2
        displayName: Install Rust
        inputs:
          scriptPath: ./ci/mac/install.sh
      -
        task: ShellScript@2
        displayName: Check Syntax
        inputs:
          scriptPath: ./ci/mac/format.sh
      -
        task: ShellScript@2
        displayName: Run Tests
        inputs:
          scriptPath: ./ci/mac/test.sh
      -
        task: ShellScript@2
        displayName: Build
        inputs:
          scriptPath: ./ci/mac/build.sh
      -
        task: ShellScript@2
        displayName: Rename Executable
        inputs:
          scriptPath: ./ci/mac/move.sh
      -
        task: PublishBuildArtifacts@1
        displayName: "Publish Artifact: Release Build"
        inputs:
          PathtoPublish: ./target/release/j2y-darwin
          ArtifactName: drop
          ArtifactType: Container
          TargetPath: "\\\\my\\share\\$(Build.DefinitionName)\\$(Build.BuildNumber)"
          Parallel: "false"
          ParallelCount: "8"
